<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Printer Gateway Tester</title>
    <style>
        body {
            font-family: monospace, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            background-color: #f4f7f6;
        }

        h1 {
            color: #333;
            text-align: center;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 10px;
            font-family: monospace;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 15px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            transition: background 0.2s;
        }

        button:hover {
            background-color: #0056b3;
        }

        button.secondary {
            background-color: #6c757d;
        }

        button.secondary:hover {
            background-color: #545b62;
        }

        #status-container {
            margin-top: 20px;
        }

        #status {
            padding: 15px;
            border: 1px solid #ddd;
            background-color: #fff;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 13px;
            border-radius: 4px;
        }

        .success {
            color: #28a745;
            font-weight: bold;
        }

        .error {
            color: #dc3545;
            font-weight: bold;
        }

        .info {
            color: #17a2b8;
        }

        hr {
            border: 0;
            border-top: 1px solid #eee;
            margin: 20px 0;
        }
    </style>
</head>

<body>

    <h1>Printer Gateway Tester</h1>

    <div class="card">
        <div class="input-group">
            <label for="serverUrl">Gateway URL (IP Address):</label>
            <input type="text" id="serverUrl" value="http://127.0.0.1:8686" placeholder="http://127.0.0.1:8686">
            <div style="margin-top: 5px;">
                <small>• Use <b>http://127.0.0.1:8686</b> if testing on the tablet itself.</small><br>
                <small>• Use <b>http://[TABLET_IP]:8686</b> if testing from a laptop.</small>
            </div>
        </div>

        <div class="btn-group">
            <button onclick="checkHealth()">Test Connection</button>
            <button onclick="downloadLogs()" class="secondary">Download Logs</button>
        </div>
    </div>

    <div class="card">
        <label for="printContent">Raw Content Test:</label>
        <textarea id="printContent" rows="3">Hello from Local Assets!
This is a raw text test.</textarea>
        <div style="margin-top: 10px;">
            <button onclick="sendRawPrint()">Print Raw Text</button>
        </div>
    </div>

    <div class="card">
        <label for="orderNum">Structured Order Test:</label>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="text" id="orderNum" value="101" style="width: 100px;">
            <span>(Order #)</span>
        </div>
        <button onclick="sendFormattedOrder()">Print Receipt (Order)</button>
    </div>

    <div id="status-container">
        <label>Console & Logs:</label>
        <div id="status">Status: Ready.</div>
    </div>

    <script>
        const statusDiv = document.getElementById('status');

        // Auto-detect if running on the gateway itself
        window.onload = function () {
            if (window.location.port === "8686") {
                document.getElementById('serverUrl').value = window.location.origin;
                log("Detected running on Gateway. URL set to " + window.location.origin, 'success');
            } else if (window.location.protocol === "file:") {
                log("Running from local file. Make sure to enter the Tablet's IP address.", 'info');
            }
        }

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] ${message}`);

            let colorClass = 'info';
            if (type === 'success') colorClass = 'success';
            if (type === 'error') colorClass = 'error';

            const logLine = `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            statusDiv.innerHTML = logLine + statusDiv.innerHTML;
        }

        async function checkHealth() {
            const baseUrl = document.getElementById('serverUrl').value.replace(/\/$/, "");
            const url = baseUrl + '/health';
            log(`Checking health at: ${url}...`);

            try {
                const response = await fetch(url);
                const data = await response.json();
                if (response.ok) {
                    log(`Server ALIVE: ${JSON.stringify(data)}`, 'success');
                } else {
                    log(`Server Error: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`Connection Failed: ${error.message}`, 'error');
            }
        }

        async function downloadLogs() {
            const baseUrl = document.getElementById('serverUrl').value.replace(/\/$/, "");
            const url = baseUrl + '/logs';
            log(`Fetching logs from: ${url}...`);

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const text = await response.text();

                const blob = new Blob([text], { type: 'text/plain' });
                const a = document.createElement('a');
                a.href = window.URL.createObjectURL(blob);
                a.download = `printer_gateway_logs.txt`;
                a.click();
                log("Logs downloaded successfully.", 'success');
            } catch (error) {
                log(`Log Retrieval Failed: ${error.message}`, 'error');
            }
        }

        async function sendRawPrint() {
            const content = document.getElementById('printContent').value;
            log(`Sending raw print job...`);
            await sendRequest({ content: content });
        }

        async function sendFormattedOrder() {
            const orderNum = document.getElementById('orderNum').value;
            const order = {
                orderNumber: orderNum,
                total: "25.50",
                headerMessage: "      Kiosk Print Test",
                footerMessage: "      Verified from Local Assets!\n       Thank you.",
                items: [
                    { name: "Double Burger", qty: "1", price: "12.00" },
                    { name: "Large Fries", qty: "1", price: "5.50" },
                    { name: "Coke", qty: "2", price: "4.00" }
                ]
            };
            log(`Sending formatted order #${orderNum}...`);
            await sendRequest({ order: order });
        }

        async function sendRequest(payload) {
            const baseUrl = document.getElementById('serverUrl').value.replace(/\/$/, "");
            const url = baseUrl + '/print';

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (response.ok) {
                    log(`PRINTER SUCCESS: ${JSON.stringify(data)}`, 'success');
                } else {
                    log(`PRINTER FAILED: ${JSON.stringify(data)}`, 'error');
                }
            } catch (error) {
                log(`NETWORK ERROR: ${error.message}`, 'error');
            }
        }
    </script>
</body>

</html>